<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Esports Company Management Simulation • Manager X</title>
  <meta name="description" content="A turn‑based, 8‑turn (2‑year) esports org management simulation. Make 3 decisions per turn and maximize rank + profit." />
  <style>
    :root{
      --bg:#0b1020; --panel:#111936; --panel-2:#0e1530; --ink:#e8eeff; --muted:#a9b7da; --line:#263a74; --accent:#6aa8ff;
      --good:#10b981; --warn:#f59e0b; --bad:#ef4444; --shadow:rgba(0,0,0,.35)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg, #0b1020, #0a0f1f);color:var(--ink);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    a{color:var(--accent)}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:clamp(22px,3vw,28px);margin:0}
    .badge{padding:4px 10px;border:1px solid var(--line);border-radius:999px;background:#0f1630;color:#cfe1ff;white-space:nowrap}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:980px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 26px var(--shadow)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--line);background:#10183a;color:#dfe9ff;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{filter:brightness(1.08)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(180deg,#1a3d86,#0e2b66);border-color:#2453a5}
    .btn.good{background:linear-gradient(180deg,#167a3a,#0e5d2b);border-color:#1a8f46}
    .btn.warn{background:linear-gradient(180deg,#8a5a10,#5f3f0b);border-color:#b07217}
    .btn.bad{background:linear-gradient(180deg,#7a1620,#5d0e14);border-color:#8f1a25}
    .btn.ghost{background:#0f1632}
    .section-title{margin:0 0 8px 0;font-weight:800;font-size:14px;color:#cfe1ff;text-transform:uppercase;letter-spacing:.08em}
    .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    @media(min-width:760px){.stats{grid-template-columns:repeat(3,1fr)}}
    .stat{background:var(--panel-2);border:1px solid var(--line);border-radius:12px;padding:10px}
    .stat b{display:block;font-size:12px;color:#bcd0ff;text-transform:uppercase;letter-spacing:.08em}
    .label{font-size:12px;color:#bcd0ff}
    .muted{color:var(--muted)}
    .opts{display:grid;gap:12px}
    .opt{display:flex;gap:12px;align-items:flex-start;background:var(--panel-2);border:1px solid var(--line);border-radius:12px;padding:12px}
    .opt input{margin-top:4px}
    .divider{height:1px;background:var(--line);margin:10px 0}
    .log{max-height:240px;overflow:auto;background:#0f1632;border:1px solid var(--line);border-radius:12px;padding:10px;white-space:pre-wrap}
    .footer{margin-top:18px;color:#9fb2e6}
    .kbd{background:#131d3e;border:1px solid var(--line);border-bottom-color:#1b2a5b;padding:2px 6px;border-radius:6px}
    .notice{padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#0e1633}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;background:#0d1534;border:1px solid var(--line);border-radius:999px}
    .center{display:flex;justify-content:center;align-items:center}
    .end{display:flex;justify-content:flex-end}
    .warntext{color:var(--warn)}
    .goodtext{color:var(--good)}
    .badtext{color:var(--bad)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="row">
        <h1>Esports Company Management Simulation</h1>
        <span class="badge">Manager X · 8 Turns · Local‑only</span>
      </div>
      <div class="row">
        <button class="btn ghost" id="btnSave">Save</button>
        <button class="btn ghost" id="btnLoad">Load</button>
        <button class="btn" id="btnReset">Reset</button>
        <button class="btn" id="btnPrint">Print</button>
      </div>
      <div class="row" id="nameRow" style="gap:8px;align-items:center">
        <label class="label" for="studentName">Student Name</label>
        <input id="studentName" type="text" placeholder="Enter your name" style="min-width:240px" />
      </div>
    </header>

    <div class="grid">
      <section class="card" id="left">
        <div class="section-title">Scenario</div>
        <div id="scenario" class="notice" aria-live="polite"></div>

        <div class="divider"></div>
        <div class="section-title">Decisions (pick 1 in each category)</div>

        <form id="choices" class="opts">
          <fieldset class="card" style="padding:12px">
            <legend class="label">1) Operations</legend>
            <label class="opt"><input type="radio" name="ops" value="analyst"> <div><b>Hire an Analyst ($20,000)</b><br><span class="muted">TSR +5 this turn; ongoing salaries +$5,000/turn.</span></div></label>
            <label class="opt"><input type="radio" name="ops" value="house"> <div><b>Upgrade Team House ($40,000)</b><br><span class="muted">Morale +10; Fans +500.</span></div></label>
            <label class="opt"><input type="radio" name="ops" value="lean"> <div><b>Stay Lean ($0)</b><br><span class="muted">No spend; risk stagnation (TSR −2).</span></div></label>
          </fieldset>

          <fieldset class="card" style="padding:12px">
            <legend class="label">2) Marketing</legend>
            <label class="opt"><input type="radio" name="mkt" value="merch"> <div><b>Launch Fan Merch ($25,000)</b><br><span class="muted">+1,000 fans now; +$10,000 next turn.</span></div></label>
            <label class="opt"><input type="radio" name="mkt" value="local"> <div><b>Host Local Tournament ($30,000)</b><br><span class="muted">+2,000 fans; Morale +5.</span></div></label>
            <label class="opt"><input type="radio" name="mkt" value="minimal"> <div><b>Minimal Social ($0)</b><br><span class="muted">Save cash; fan growth flat.</span></div></label>
          </fieldset>

          <fieldset class="card" style="padding:12px">
            <legend class="label">3) Player Focus</legend>
            <label class="opt"><input type="radio" name="ply" value="bootcamp"> <div><b>Intense Training Bootcamp ($0)</b><br><span class="muted">TSR +8; Morale −10.</span></div></label>
            <label class="opt"><input type="radio" name="ply" value="retreat"> <div><b>Team Bonding Retreat ($10,000)</b><br><span class="muted">Morale +10; TSR −3.</span></div></label>
            <label class="opt"><input type="radio" name="ply" value="balanced"> <div><b>Balanced Schedule ($0)</b><br><span class="muted">TSR +2; Morale +2.</span></div></label>
          </fieldset>
        </form>

        <div class="row end" style="margin-top:10px">
          <button class="btn primary" id="btnConfirm"><b>Confirm Decisions & Run Turn</b></button>
        </div>

        <div class="divider"></div>
        <div class="section-title">Turn Log</div>
        <div id="log" class="log" aria-live="polite"></div>
      </section>

      <aside class="card" id="right">
        <div class="section-title">Status</div>
        <div class="stats" id="stats"></div>
        <div class="divider"></div>
        <div class="section-title">Notes</div>
        <ul class="muted" style="margin-top:0">
          <li>Game is 8 turns (2 years; 1 turn = quarter).</li>
          <li>Pick <b>one</b> option per category each turn.</li>
          <li>Fixed expenses (salaries) are deducted each turn.</li>
          <li>Everything runs locally in your browser. Use <b>Save</b>/<b>Load</b> to carry progress.</li>
        </ul>
        <div class="divider"></div>
        <details>
          <summary>How scoring works</summary>
          <p class="muted">Final Score is based on <b>Rank</b> and <b>Profit</b> (ending cash minus $250,000 starting cash). Rank points: Tier 1 = 100, Tier 2 = 60, Tier 3 = 30. Profit points: profit ÷ $2,000 (negative cash = penalties).</p>
        </details>
      </aside>
    </div>

    <p class="footer">Made for classrooms · No logins · No servers · <span class="kbd">Ctrl/Cmd+S</span> to save this file after playing if you edit it.</p>
  </div>

  <script>
  ;(() => {
    const STARTING = {
      turn: 1,
      turnsTotal: 8,
      cash: 250000,
      salaries: 30000,
      fans: 5000,
      tsr: 60,
      morale: 70,
      rank: 3, // 3=Tier 3 (Rookie), 2=Tier 2 (Challenger), 1=Tier 1 (Elite)
      analysts: 0,
      merchPayoutNext: 0,
      negCashStreak: 0,
      history: [], name: '' // per turn snapshots & student name
    }

    let S = JSON.parse(JSON.stringify(STARTING))

    const el = id => document.getElementById(id)
    const $stats = el('stats')
    const $scenario = el('scenario')
    const $log = el('log')
    const $name = el('studentName')

    const fmtMoney = n => `$${n.toLocaleString()}`
    const clamp = (v,min,max) => Math.max(min, Math.min(max, v))

    function rankName(t){ return t===1? 'Tier 1 (Elite)' : t===2? 'Tier 2 (Challenger)' : 'Tier 3 (Rookie)' }

    function scenarioText(){
      if (S.turn === 1) {
        return `<b>Turn 1 — A New Season Dawns</b><br>Spring Split is here. Sponsors are watching and your players are hungry. Competition is fierce and finances are tight.`
      }
      const flavors = [
        'Scrim results leak online — fans debate your true power level.',
        'A regional rival signs a star; pressure rises to respond.',
        'Patch notes shake the meta; your coaches scramble.',
        'Travel snafus disrupt practice; leadership is tested.',
        'A viral clip from your support player boosts visibility.',
        'Analyst desk calls your team a dark horse; expectations climb.'
      ]
      const idx = (S.turn + S.fans + S.tsr) % flavors.length
      return `<b>Turn ${S.turn}</b> — ${flavors[idx]}`
    }

    function render(){
      $scenario.innerHTML = scenarioText()
      $stats.innerHTML = `
        ${stat('Turn', `${S.turn} / ${S.turnsTotal}`)}
        ${stat('Cash Reserves', fmtMoney(S.cash))}
        ${stat('Fixed Expenses', fmtMoney(S.salaries) + ' / turn')}
        ${stat('Fan Base', S.fans.toLocaleString() + ' followers')}
        ${stat('Team Skill Rating', S.tsr + ' / 100')}
        ${stat('Player Morale', S.morale + ' / 100')}
        ${stat('Team Rank', rankName(S.rank))}
        ${stat('Analysts on Staff', String(S.analysts))}
      `
      if ($name) $name.value = S.name || ''
    } / ${S.turnsTotal}`)}
        ${stat('Cash Reserves', fmtMoney(S.cash))}
        ${stat('Fixed Expenses', fmtMoney(S.salaries) + ' / turn')}
        ${stat('Fan Base', S.fans.toLocaleString() + ' followers')}
        ${stat('Team Skill Rating', S.tsr + ' / 100')}
        ${stat('Player Morale', S.morale + ' / 100')}
        ${stat('Team Rank', rankName(S.rank))}
        ${stat('Analysts on Staff', String(S.analysts))}
      `
    }

    function stat(label, value){
      return `<div class="stat"><b>${label}</b><div>${value}</div></div>`
    }

    function appendLog(lines){
      const text = Array.isArray(lines) ? lines.join('
') : String(lines)
      $log.textContent = (text + '
' + $log.textContent).trim()
    }

    function getChoice(name){
      const q = document.querySelector(`input[name="${name}"]:checked`)
      return q ? q.value : null
    }

    function clearChoices(){
      document.querySelectorAll('input[type=radio]').forEach(i=>i.checked=false)
    }

    // ---- Core simulation helpers per your Logic Rules ----
    function opponentDifficulty(){
      // Base difficulty by current rank (harder as rank improves), plus light variance
      const base = (S.rank === 3 ? 65 : S.rank === 2 ? 75 : 85)
      const jitter = Math.floor(Math.random()*11) - 5 // -5..+5
      return Math.max(40, base + jitter)
    }

    function winProbability(){
      const opp = opponentDifficulty()
      const moraleMultiplier = S.morale / 100
      let p = (S.tsr * moraleMultiplier) / opp
      return clamp(p, 0.05, 0.95)
    }

    function academicFeedback(pl, totals){
      // one sentence tied to a concept
      const { revenue, expenses, fixed, variable } = totals
      if (pl < 0 && revenue < fixed) return 'Your revenue did not reach the break‑even point; fixed costs exceeded contribution margin.'
      if (pl < 0 && variable > fixed) return 'High variable costs eroded margins this turn; tighten discretionary spending.'
      if (pl >= 0 && revenue > expenses) return 'Positive contribution margin covered fixed costs and produced profit—well managed.'
      if (pl < 0) return 'A net loss increased liabilities pressure; consider boosting sponsorship assets or cutting costs.'
      return 'Stable performance with costs under control; maintain assets that drive recurring revenue.'
    }

    function applyDecisions(ops, mkt, ply){
      let log = []

      // Collect variable costs from decisions (do not touch cash yet)
      let variableCosts = 0

      // ---- Decisions: effects + variable costs ----
      if (ops === 'analyst'){
        variableCosts += 20000
        S.tsr += 5
        S.salaries += 5000 // increases FIXED expenses
        S.analysts += 1
        log.push('Operations: Hired an Analyst (Variable −$20,000; Fixed +$5,000/turn; TSR +5).')
      } else if (ops === 'house'){
        variableCosts += 40000
        S.morale += 10
        S.fans += 500
        log.push('Operations: Upgraded Team House (Variable −$40,000; Morale +10; Fans +500).')
      } else if (ops === 'lean'){
        S.tsr -= 2
        log.push('Operations: Stayed Lean (no spend; TSR −2).')
      }

      if (mkt === 'merch'){
        variableCosts += 25000
        S.fans += 1000
        S.merchPayoutNext += 10000 // will count as revenue next turn
        log.push('Marketing: Launched Merch (Variable −$25,000; +1,000 Fans; +$10,000 merch revenue queued for next turn).')
      } else if (mkt === 'local'){
        variableCosts += 30000
        S.fans += 2000
        S.morale += 5
        log.push('Marketing: Hosted Local Tournament (Variable −$30,000; +2,000 Fans; Morale +5).')
      } else if (mkt === 'minimal'){
        log.push('Marketing: Minimal Social (no variable spend).')
      }

      if (ply === 'bootcamp'){
        S.tsr += 8
        S.morale -= 10
        log.push('Player Focus: Intense Bootcamp (TSR +8; Morale −10).')
      } else if (ply === 'retreat'){
        variableCosts += 10000
        S.morale += 10
        S.tsr -= 3
        log.push('Player Focus: Team Retreat (Variable −$10,000; Morale +10; TSR −3).')
      } else if (ply === 'balanced'){
        S.tsr += 2
        S.morale += 2
        log.push('Player Focus: Balanced Schedule (TSR +2; Morale +2).')
      }

      // Clamp ranges
      S.tsr = clamp(Math.round(S.tsr), 0, 100)
      S.morale = clamp(Math.round(S.morale), 0, 100)

      // ---- Competitive Logic: Win/Loss via probability ----
      const pWin = winProbability()
      const didWin = Math.random() < pWin

      // Prize money by rank on win
      const prizeTable = {1: 60000, 2: 35000, 3: 20000}
      let prizeMoney = didWin ? prizeTable[S.rank] : 0

      if (didWin){
        S.fans += 1500
        log.push(`Tournament outcome: WIN (p=${(pWin*100).toFixed(1)}%). Prize ${fmtMoney(prizeMoney)}, Fans +1,500.`)
      } else {
        // Consequences of Loss (Financial Ruin rule): sponsor penalty + fan drop 5%
        variableCosts += 10000 // Liability cost
        const fansBefore = S.fans
        S.fans = Math.max(0, Math.round(S.fans * 0.95))
        log.push(`Tournament outcome: LOSS (p=${(pWin*100).toFixed(1)}%). Sponsor penalty −$10,000; Fans ${fansBefore.toLocaleString()} → ${S.fans.toLocaleString()} (−5%).`)
      }

      // ---- Financial Calculation Logic (must be shown every turn) ----
      const sponsorships = Math.round((S.rank === 1 ? 30000 : S.rank === 2 ? 18000 : 9000) + Math.max(0, S.tsr - 50) * 120)
      const merchSales = S.merchPayoutNext
      S.merchPayoutNext = 0 // consumed this turn if any

      const fixedExpenses = S.salaries
      const travel = 5000 // baseline travel/logistics per turn
      variableCosts += travel

      const totalRevenue = sponsorships + merchSales + prizeMoney
      const totalExpenses = fixedExpenses + variableCosts
      const profitLoss = totalRevenue - totalExpenses

      S.cash += profitLoss

      // Rank momentum (simple thresholds)
      let promoted = false, demoted = false
      if (S.rank === 3 && S.tsr >= 70 && S.fans >= 7000){ S.rank = 2; promoted = true }
      else if (S.rank === 2 && S.tsr >= 80 && S.fans >= 12000){ S.rank = 1; promoted = true }
      else if (S.tsr <= 50 && S.morale <= 40 && S.fans < 5000 && S.rank < 3){ S.rank = 3; demoted = true }
      if (promoted) log.push(`Rank update: Promoted to ${rankName(S.rank)}!`)
      if (demoted) log.push(`Rank update: Demoted to ${rankName(S.rank)}.`)

      // Academic feedback
      const fb = academicFeedback(profitLoss, {
        revenue: totalRevenue,
        expenses: totalExpenses,
        fixed: fixedExpenses,
        variable: variableCosts
      })

      // Turn finance summary (explicit, per requirement A)
      log.push(
        'FINANCE SUMMARY — shown this turn:'
      )
      log.push(
        `  Total Revenue = Sponsorships (${fmtMoney(sponsorships)}) + Merch Sales (${fmtMoney(merchSales)}) + Prize Money (${fmtMoney(prizeMoney)}) = ${fmtMoney(totalRevenue)}`
      )
      log.push(
        `  Total Expenses = Fixed (${fmtMoney(fixedExpenses)}) + Variable (${fmtMoney(variableCosts)}) = ${fmtMoney(totalExpenses)}`
      )
      log.push(
        `  Profit/Loss (P/L) = ${fmtMoney(totalRevenue)} − ${fmtMoney(totalExpenses)} = ${fmtMoney(profitLoss)}`
      )
      log.push(
        `  Updated Cash Reserves: ${fmtMoney(S.cash)}`
      )
      log.push(
        `Academic Feedback: ${fb}`
      )

      // Save history snapshot
      S.history.push({
        turn:S.turn, cash:S.cash, salaries:S.salaries, fans:S.fans, tsr:S.tsr, morale:S.morale, rank:S.rank,
        revenue:{sponsorships, merchSales, prizeMoney},
        expenses:{fixed:fixedExpenses, variable:variableCosts},
        pl:profitLoss,
        notes: log
      })

      appendLog([`Turn ${S.turn} summary:`, ...log, '––––––––––––––––––––––––––––––––––––––––'])

      // ---- Game Over checks (after every turn) ----
      if (S.cash < 0) S.negCashStreak = (S.negCashStreak||0) + 1; else S.negCashStreak = 0
      if (S.negCashStreak >= 2){
        gameOver('Financial Ruin', 'Cash reserves were below $0 for two consecutive turns.')
        return
      }
      if (S.morale <= 0){
        gameOver('Mutiny', 'Player morale fell to 0. The roster refuses to compete.')
        return
      }
    }

    function gameOver(reason, detail){
      const report = `
GAME OVER — ${reason}
${detail}
Final Cash: ${fmtMoney(S.cash)}
Fans: ${S.fans.toLocaleString()}
Rank: ${rankName(S.rank)}
Turns played: ${S.turn} / ${S.turnsTotal}`
      appendLog(report)
      el('btnConfirm').disabled = true
      $scenario.innerHTML = `<b>Game Over:</b> ${reason}. ${detail}`
    }

    function endIfNeeded(){
      if (S.turn >= S.turnsTotal){
        const endingCash = S.cash
        const endingRank = S.rank
        const endingFans = S.fans
        const profit = endingCash - STARTING.cash

        const rankSub = (endingRank === 1 ? 100 : endingRank === 2 ? 60 : 30)
        const profitSub = (function(){
          const min = -100000, max = 200000
          const pct = (profit - min) / (max - min)
          return clamp(Math.round(pct*100), 0, 100)
        })()
        const fanSub = clamp(Math.round((endingFans / 20000) * 100), 0, 100)

        const finalScore = Math.round(rankSub*0.40 + profitSub*0.40 + fanSub*0.20)

        function assessment(){
          const avoidedRuin = (S.negCashStreak||0) < 2 && !(endingCash < 0)
          const balanced = (S.tsr >= 60 && S.morale >= 60) || (profit > 0 && endingRank <= 2)
          const profitable = profit > 0
          const a = avoidedRuin ? 'You avoided financial ruin' : 'You flirted with financial ruin'
          const b = balanced ? 'balanced short‑term performance with long‑term capability building' : 'over‑weighted either short‑term pushes or long‑term investments'
          const c = profitable ? 'your revenues exceeded expenses to produce profit' : 'expenses outpaced revenues, resulting in a loss'
          return `${a}, ${b}, and ${c}. Consider how fixed costs (salaries) and variable decisions (marketing, travel, retreats) influenced contribution margin and your path to break‑even.`
        }

        const screen = `
          <div class="notice">
            <b>STOP the turn‑based simulation.</b> You have reached the end of Turn 8.
          </div>
          <h3>Final Scoring Screen</h3>
          <div class=\"stats\">
            ${stat('Student', (S.name && S.name.trim()) ? S.name.trim() : 'Manager X')}
            ${stat('Final Cash Reserves', fmtMoney(endingCash))}
            ${stat('Final Team Rank', rankName(endingRank))}
            ${stat('Final Fan Base', endingFans.toLocaleString() + ' followers')}
          </div>
          <div class=\"divider\"></div>
          <div class="section-title">Score Breakdown (out of 100)</div>
          <div class="stat">Rank Score (40%): ${rankSub} → ×0.40 = ${(rankSub*0.40).toFixed(1)}</div>
          <div class="stat">Profit Score (40%): ${profitSub} → ×0.40 = ${(profitSub*0.40).toFixed(1)}</div>
          <div class="stat">Fan Base Score (20%): ${fanSub} → ×0.20 = ${(fanSub*0.20).toFixed(1)}</div>
          <div class="stat"><b>Final Score</b>: ${finalScore} / 100</div>
          <div class="divider"></div>
          <div class="section-title">Final Assessment</div>
          <p class="muted">${assessment()}</p>
          <div class="divider"></div>
          <div class="end"><button id="btnPDF" class="btn good"><b>Save Final Report (PDF)</b></button></div>
        `

        $scenario.innerHTML = screen
        const pdfBtn = document.getElementById('btnPDF'); if(pdfBtn){ pdfBtn.addEventListener('click', ()=>window.print()) }
        appendLog([`FINAL VALUES: Cash ${fmtMoney(endingCash)} · Rank ${rankName(endingRank)} · Fans ${endingFans.toLocaleString()}`])
        el('btnConfirm').disabled = true
      }
    }

    // UI events
    el('btnConfirm').addEventListener('click', () => {
      if (S.turn > S.turnsTotal){ return }
      const ops = getChoice('ops')
      const mkt = getChoice('mkt')
      const ply = getChoice('ply')
      if (!ops || !mkt || !ply){
        alert('Please make exactly one selection in each category (Operations, Marketing, Player Focus).')
        return
      }
      if (!$name || !($name.value || '').trim()){
        if (!confirm('Proceed without entering a student name? It will show as "Manager X" on the final report.')) return
        S.name = ''
      } else {
        S.name = ($name.value || '').trim()
      }

      applyDecisions(ops, mkt, ply)
      clearChoices()

      S.turn += 1
      render()
      endIfNeeded()
      saveLocal('autosave', S)
    })

    el('btnReset').addEventListener('click', () => {
      if (!confirm('Reset game to Turn 1?')) return
      S = JSON.parse(JSON.stringify(STARTING))
      $log.textContent = ''
      render()
      el('btnConfirm').disabled = false
      saveLocal('autosave', S)
    })

    el('btnPrint').addEventListener('click', () => window.print())

    el('btnSave').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(S, null, 2)], {type:'application/json'})
      const a = document.createElement('a')
      a.href = URL.createObjectURL(blob)
      a.download = 'managerx-save.json'
      a.click()
      URL.revokeObjectURL(a.href)
    })

    el('btnLoad').addEventListener('click', () => {
      const inp = document.createElement('input')
      inp.type = 'file'
      inp.accept = '.json,application/json'
      inp.onchange = () => {
        const f = inp.files && inp.files[0]
        if (!f) return
        const reader = new FileReader()
        reader.onload = () => {
          try{
            const data = JSON.parse(reader.result)
            Object.assign(S, data)
            render()
            $log.textContent = ''
            appendLog('Save loaded. Continue your run!')
          }catch(err){ alert('Could not load save file.') }
        }
        reader.readAsText(f)
      }
      inp.click()
    })

    function saveLocal(key, obj){ try{ localStorage.setItem(key, JSON.stringify(obj)) }catch(_){} }
    function loadLocal(key){ try{ return JSON.parse(localStorage.getItem(key)||'null') }catch(_){ return null } }

    const auto = loadLocal('autosave')
    if (auto && auto.turn && auto.turn <= auto.turnsTotal+1){
      S = auto
      appendLog('Autosave loaded. Continue where you left off!')
    } else {
      appendLog('Welcome, Manager X! Pick one option in each category, then confirm to run the turn.')
    }

    render()
  })()
  </script>
</body>
</html>
