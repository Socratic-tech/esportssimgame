<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Esports Company Management Simulation ‚Ä¢ Manager X</title>
  <meta name="description" content="A turn‚Äëbased, 8‚Äëturn (2‚Äëyear) esports org management simulation. Make 3 decisions per turn and maximize rank + profit." />
  <style>
    :root{
      --bg:#0b1020; --panel:#111936; --panel-2:#0e1530; --ink:#e8eeff; --muted:#a9b7da; --line:#263a74; --accent:#6aa8ff;
      --good:#10b981; --warn:#f59e0b; --bad:#ef4444; --shadow:rgba(0,0,0,.35)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg, #0b1020, #0a0f1f);color:var(--ink);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    a{color:var(--accent)}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap}
    h1{font-size:clamp(22px,3vw,28px);margin:0}
    h2{font-size:20px;margin:16px 0 8px 0;color:#cfe1ff}
    h3{font-size:18px;margin:12px 0 8px 0;color:#cfe1ff}
    .badge{padding:4px 10px;border:1px solid var(--line);border-radius:999px;background:#0f1630;color:#cfe1ff;white-space:nowrap}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:980px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 26px var(--shadow)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--line);background:#10183a;color:#dfe9ff;padding:10px 14px;border-radius:12px;cursor:pointer;font-size:14px}
    .btn:hover{filter:brightness(1.08)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(180deg,#1a3d86,#0e2b66);border-color:#2453a5}
    .btn.good{background:linear-gradient(180deg,#167a3a,#0e5d2b);border-color:#1a8f46}
    .btn.warn{background:linear-gradient(180deg,#8a5a10,#5f3f0b);border-color:#b07217}
    .btn.bad{background:linear-gradient(180deg,#7a1620,#5d0e14);border-color:#8f1a25}
    .btn.ghost{background:#0f1632}
    .section-title{margin:0 0 8px 0;font-weight:800;font-size:14px;color:#cfe1ff;text-transform:uppercase;letter-spacing:.08em}
    .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    @media(min-width:760px){.stats{grid-template-columns:repeat(3,1fr)}}
    .stat{background:var(--panel-2);border:1px solid var(--line);border-radius:12px;padding:10px}
    .stat b{display:block;font-size:12px;color:#bcd0ff;text-transform:uppercase;letter-spacing:.08em}
    .label{font-size:12px;color:#bcd0ff}
    .muted{color:var(--muted)}
    .opts{display:grid;gap:12px}
    .opt{display:flex;gap:12px;align-items:flex-start;background:var(--panel-2);border:1px solid var(--line);border-radius:12px;padding:12px}
    .opt input{margin-top:4px}
    .divider{height:1px;background:var(--line);margin:10px 0}
    .log{max-height:240px;overflow:auto;background:#0f1632;border:1px solid var(--line);border-radius:12px;padding:10px;white-space:pre-wrap;font-size:13px;line-height:1.6}
    .footer{margin-top:18px;color:#9fb2e6;font-size:14px}
    .kbd{background:#131d3e;border:1px solid var(--line);border-bottom-color:#1b2a5b;padding:2px 6px;border-radius:6px}
    .notice{padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#0e1633}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;background:#0d1534;border:1px solid var(--line);border-radius:999px}
    .center{display:flex;justify-content:center;align-items:center}
    .end{display:flex;justify-content:flex-end}
    .warntext{color:var(--warn)}
    .goodtext{color:var(--good)}
    .badtext{color:var(--bad)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    
    /* Modal styles */
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px}
    .modal{background:var(--panel);border:2px solid var(--accent);border-radius:16px;max-width:700px;max-height:90vh;overflow-y:auto;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,0.5)}
    .modal h2{margin-top:0;color:#6aa8ff}
    .modal ul{margin:8px 0;padding-left:24px}
    .modal li{margin:4px 0}
    .term{background:var(--panel-2);border-left:3px solid var(--accent);padding:8px 12px;margin:8px 0;border-radius:4px}
    .term strong{color:#6aa8ff}
    .highlight{background:rgba(106,168,255,0.15);padding:2px 6px;border-radius:4px;color:#6aa8ff}
    details{margin:12px 0;background:var(--panel-2);border:1px solid var(--line);border-radius:12px;padding:12px}
    summary{cursor:pointer;font-weight:600;color:#cfe1ff;user-select:none}
    summary:hover{color:var(--accent)}
    .help-icon{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;background:var(--accent);color:white;border-radius:50%;font-size:12px;font-weight:bold;cursor:help;margin-left:4px}
  </style>
</head>
<body>
  <!-- Tutorial Modal -->
  <div id="tutorialModal" class="modal-overlay" style="display:none">
    <div class="modal">
      <h2>üìö Welcome to Esports Company Management!</h2>
      
      <p>You're the manager of a new esports organization. Your goal is to build a successful team over <strong>8 turns (2 years)</strong> by making smart business decisions.</p>
      
      <h3>üéÆ How to Play</h3>
      <ol>
        <li><strong>Each turn = 3 months (one quarter)</strong> of company operations</li>
        <li><strong>Make 3 decisions per turn</strong> ‚Äî one from each category:
          <ul>
            <li><span class="highlight">Operations</span>: Infrastructure & support staff</li>
            <li><span class="highlight">Marketing</span>: Growing your fanbase & revenue</li>
            <li><span class="highlight">Player Focus</span>: Training & team culture</li>
          </ul>
        </li>
        <li><strong>Your team competes in a tournament each turn</strong> ‚Äî win probability depends on TSR & morale</li>
        <li><strong>Manage your finances</strong> ‚Äî balance expenses with tournament prizes and sponsorships</li>
        <li><strong>Survive 8 turns</strong> without running out of money or losing player morale</li>
        <li><strong>Maximize your final score</strong> based on team rank, profit, and fanbase</li>
      </ol>

      <h3>üìä Key Terms & Metrics</h3>
      
      <div class="term">
        <strong>Cash Reserves:</strong> Your available money. You start with $250,000. If you go negative for 2 turns in a row, you declare bankruptcy and lose!
      </div>
      
      <div class="term">
        <strong>Salaries (Fixed Costs):</strong> Money you pay your team every turn. Starts at $30,000/turn and increases if you hire more staff (like analysts).
      </div>
      
      <div class="term">
        <strong>TSR (Team Skill Rating):</strong> How good your players are at competing (0-100 scale). Higher TSR = better win probability & tournament prizes. Improves through training and analysts.
      </div>
      
      <div class="term">
        <strong>Morale:</strong> How happy your players are (0-100 scale). Affects tournament performance. If morale hits 0, your players quit and you lose! Balance training intensity with team bonding.
      </div>
      
      <div class="term">
        <strong>Fans:</strong> Your fanbase size. More fans = promotion requirements met faster. Fans grow through marketing, tournaments, and winning.
      </div>
      
      <div class="term">
        <strong>Rank (Tier):</strong> Your team's competitive tier based on TSR and fanbase:
        <ul>
          <li><strong>Tier 3 (Rookie):</strong> Starting teams, TSR < 70, $20K prize when you win</li>
          <li><strong>Tier 2 (Challenger):</strong> Mid-level teams, TSR 70-79, $35K prize when you win</li>
          <li><strong>Tier 1 (Elite):</strong> Top-tier teams, TSR 80+, $60K prize when you win</li>
        </ul>
      </div>

      <h3>üí° Strategy Tips</h3>
      <ul>
        <li><strong>Win tournaments early!</strong> Prize money is your main income source. Build TSR fast.</li>
        <li><strong>Watch your fixed costs:</strong> Every analyst you hire costs $5,000/turn forever.</li>
        <li><strong>TSR vs Morale trade-offs:</strong> Both affect win probability - find the right balance.</li>
        <li><strong>Losing hurts:</strong> You lose 5% of fans and pay a $10K penalty when you lose tournaments.</li>
        <li><strong>Sponsorships scale with rank:</strong> Elite teams get $30K/turn base, Rookies only get $9K/turn.</li>
        <li><strong>Avoid bankruptcy:</strong> Going below $0 for 2 turns = game over!</li>
      </ul>

      <h3>üèÜ Winning the Game</h3>
      <p>Your final score is based on:</p>
      <ul>
        <li><strong>40% Team Rank</strong> (Tier 1 = best score)</li>
        <li><strong>40% Profit</strong> (Ending cash minus starting $250K)</li>
        <li><strong>20% Fanbase</strong> (More fans = better score)</li>
      </ul>

      <div class="row" style="justify-content:center;margin-top:20px">
        <button class="btn primary" id="btnStartGame"><b>Got It! Start Playing ‚Üí</b></button>
      </div>
      
      <p class="muted" style="text-align:center;margin-top:12px;font-size:13px">
        You can review the glossary anytime by clicking "View Glossary" in the sidebar
      </p>
    </div>
  </div>

  <div class="wrap">
    <header>
      <div class="row">
        <h1>Esports Company Management Simulation</h1>
        <span class="badge">Manager X ¬∑ 8 Turns ¬∑ Local‚Äëonly</span>
      </div>
      <div class="row">
        <button class="btn ghost" id="btnHelp">üìö Tutorial</button>
        <button class="btn ghost" id="btnSave">Save</button>
        <button class="btn ghost" id="btnLoad">Load</button>
        <button class="btn" id="btnReset">Reset</button>
        <button class="btn" id="btnPrint">Print</button>
      </div>
      <div class="row" id="nameRow" style="gap:8px;align-items:center">
        <label class="label" for="studentName">Student Name</label>
        <input id="studentName" type="text" placeholder="Enter your name" style="min-width:240px;padding:8px;background:#0e1530;border:1px solid var(--line);border-radius:8px;color:var(--ink)" />
      </div>
    </header>

    <div class="grid">
      <section class="card" id="left">
        <div class="section-title">Scenario</div>
        <div id="scenario" class="notice" aria-live="polite"></div>

        <div class="divider"></div>
        <div class="section-title">Decisions (pick 1 in each category)</div>

        <form id="choices" class="opts">
          <fieldset class="card" style="padding:12px;border:none">
            <legend class="label">1) Operations <span class="help-icon" title="Infrastructure and support staff decisions">?</span></legend>
            <label class="opt"><input type="radio" name="ops" value="analyst"> <div><b>Hire an Analyst ($20,000)</b><br><span class="muted">TSR +5 this turn; ongoing salaries +$5,000/turn. Analysts improve team skill but increase fixed costs.</span></div></label>
            <label class="opt"><input type="radio" name="ops" value="house"> <div><b>Upgrade Team House ($40,000)</b><br><span class="muted">Morale +10; Fans +500. Better facilities make players happier and attract new fans.</span></div></label>
            <label class="opt"><input type="radio" name="ops" value="lean"> <div><b>Stay Lean ($0)</b><br><span class="muted">No spend; risk stagnation (TSR ‚àí2). Save cash but fall behind in training quality.</span></div></label>
          </fieldset>

          <fieldset class="card" style="padding:12px;border:none">
            <legend class="label">2) Marketing <span class="help-icon" title="Growing your fanbase and revenue streams">?</span></legend>
            <label class="opt"><input type="radio" name="mkt" value="merch"> <div><b>Launch Fan Merch ($25,000)</b><br><span class="muted">+1,000 fans now; +$10,000 next turn. Upfront investment that pays back through merchandise sales.</span></div></label>
            <label class="opt"><input type="radio" name="mkt" value="local"> <div><b>Host Local Tournament ($30,000)</b><br><span class="muted">+2,000 fans; Morale +5. Community events grow your brand and energize the team.</span></div></label>
            <label class="opt"><input type="radio" name="mkt" value="minimal"> <div><b>Minimal Social ($0)</b><br><span class="muted">Save cash; fan growth flat. Maintain current audience without new marketing spend.</span></div></label>
          </fieldset>

          <fieldset class="card" style="padding:12px;border:none">
            <legend class="label">3) Player Focus <span class="help-icon" title="Training intensity vs team culture balance">?</span></legend>
            <label class="opt"><input type="radio" name="ply" value="bootcamp"> <div><b>Intense Training Bootcamp ($0)</b><br><span class="muted">TSR +8; Morale ‚àí10. Grueling practice improves skills but burns out players.</span></div></label>
            <label class="opt"><input type="radio" name="ply" value="retreat"> <div><b>Team Bonding Retreat ($10,000)</b><br><span class="muted">Morale +10; TSR ‚àí3. Build team chemistry at the cost of practice time.</span></div></label>
            <label class="opt"><input type="radio" name="ply" value="balanced"> <div><b>Balanced Schedule ($0)</b><br><span class="muted">TSR +2; Morale +2. Steady improvement in both areas without extremes.</span></div></label>
          </fieldset>
        </form>

        <div class="row end" style="margin-top:10px">
          <button class="btn primary" id="btnConfirm"><b>Confirm Decisions & Run Turn</b></button>
        </div>

        <div class="divider"></div>
        <div class="section-title">Turn Log</div>
        <div id="log" class="log" aria-live="polite"></div>
      </section>

      <aside class="card" id="right">
        <div class="section-title">Status</div>
        <div class="stats" id="stats"></div>
        
        <div class="divider"></div>
        <details>
          <summary>üìñ View Glossary</summary>
          <div style="margin-top:12px;font-size:14px">
            <p><strong>Cash:</strong> Available money. Start: $250K. Bankruptcy if negative for 2 turns.</p>
            <p><strong>Salaries:</strong> Fixed costs paid each turn. Start: $30K/turn.</p>
            <p><strong>TSR:</strong> Team Skill Rating (0-100). Higher = better win chance & tournament prizes.</p>
            <p><strong>Morale:</strong> Player happiness (0-100). Affects performance. Reaches 0 = players quit = game over.</p>
            <p><strong>Fans:</strong> Fanbase size. Required for rank promotions (7K for Tier 2, 12K for Tier 1).</p>
            <p><strong>Rank:</strong> Tier 3 (Rookie, $20K prize) ‚Üí Tier 2 (Challenger, $35K) ‚Üí Tier 1 (Elite, $60K)</p>
            <p><strong>Tournaments:</strong> Each turn has a tournament. Win = prize money + fans. Lose = penalty ‚àí fans.</p>
          </div>
        </details>
        
        <div class="divider"></div>
        <div class="section-title">Quick Reference</div>
        <ul class="muted" style="margin-top:0;font-size:14px">
          <li>Game is 8 turns (2 years; 1 turn = quarter).</li>
          <li>Pick <b>one</b> option per category each turn.</li>
          <li>Every turn: tournament competition for prizes!</li>
          <li>Win probability = (TSR √ó Morale%) √∑ opponent strength</li>
          <li>Fixed expenses (salaries + travel) deducted each turn.</li>
          <li>Balance spending, training, and team happiness!</li>
        </ul>
        
        <div class="divider"></div>
        <details>
          <summary>üéØ How Scoring Works</summary>
          <p class="muted" style="margin-top:8px">Final Score is based on <b>Rank</b> (40%), <b>Profit</b> (40%), and <b>Fans</b> (20%). 
          <br><br>Rank points: Tier 1 = 100, Tier 2 = 60, Tier 3 = 30. 
          <br>Profit = ending cash minus $250K starting cash. 
          <br>Aim for Tier 1 rank with positive profit!</p>
        </details>
      </aside>
    </div>

    <p class="footer">Made for classrooms ¬∑ No logins ¬∑ No servers ¬∑ <span class="kbd">Ctrl/Cmd+S</span> to save this file after playing</p>
  </div>

  <script>
  ;(() => {
    const STARTING = {
      turn: 1,
      turnsTotal: 8,
      cash: 250000,
      salaries: 30000,
      fans: 5000,
      tsr: 60,
      morale: 70,
      rank: 3,
      analysts: 0,
      merchPayoutNext: 0,
      negCashStreak: 0,
      history: [],
      name: '',
      seenTutorial: false
    }

    let S = JSON.parse(JSON.stringify(STARTING))

    const el = id => document.getElementById(id)
    const $stats = el('stats')
    const $scenario = el('scenario')
    const $log = el('log')
    const $name = el('studentName')
    const $modal = el('tutorialModal')

    const fmtMoney = n => `$${n.toLocaleString()}`
    const clamp = (v,min,max) => Math.max(min, Math.min(max, v))
    const rankName = t => t===1? 'Tier 1 (Elite)' : t===2? 'Tier 2 (Challenger)' : 'Tier 3 (Rookie)'

    function render(){
      const yr = Math.floor((S.turn-1) / 4) + 1
      const qtr = ((S.turn-1) % 4) + 1
      const desc = `Year ${yr}, Quarter ${qtr} (Turn ${S.turn} / ${S.turnsTotal})`

      $scenario.innerHTML = `
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <b>${desc}</b>
          <span class="pill">üí∞ ${fmtMoney(S.cash)}</span>
          <span class="pill">üë• ${S.fans.toLocaleString()} fans</span>
          <span class="pill">üèÜ ${rankName(S.rank)}</span>
        </div>
        <p style="margin-top:8px;font-size:14px" class="muted">Make your three decisions below, then click <b>Confirm Decisions</b> to run the tournament and advance to the next quarter.</p>
      `

      const stat = (key,val,note) => `<div class="stat"><b>${key}</b><div style="font-size:20px;margin:4px 0">${val}</div>${note?`<div class="muted" style="font-size:12px">${note}</div>`:''}</div>`

      $stats.innerHTML = `
        ${stat('Cash', fmtMoney(S.cash), S.cash < 0 ? '<span class="badtext">‚ö† Negative!</span>' : '')}
        ${stat('Salaries / turn', fmtMoney(S.salaries))}
        ${stat('Fans', S.fans.toLocaleString())}
        ${stat('TSR', S.tsr, 'Team Skill Rating')}
        ${stat('Morale', S.morale, S.morale < 30 ? '<span class="warntext">‚ö† Low!</span>' : '')}
        ${stat('Rank', rankName(S.rank))}
      `
    }

    function appendLog(lines){
      const arr = Array.isArray(lines) ? lines : [lines]
      arr.forEach(ln => {
        const div = document.createElement('div')
        div.textContent = ln
        div.style.margin = '4px 0'
        $log.appendChild(div)
      })
      $log.scrollTop = $log.scrollHeight
    }

    function getChoice(cat){
      const radio = document.querySelector(`input[name="${cat}"]:checked`)
      return radio ? radio.value : null
    }

    function clearChoices(){
      document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false)
    }

    function winProbability(){
      const baseOpponent = 60
      const moraleMultiplier = S.morale / 100
      let p = (S.tsr * moraleMultiplier) / baseOpponent
      return clamp(p, 0.05, 0.95)
    }

    function academicFeedback(pl, totals){
      const { revenue, expenses, fixed, variable } = totals
      if (pl < 0 && revenue < fixed) return 'Your revenue did not reach the break‚Äëeven point; fixed costs exceeded contribution margin.'
      if (pl < 0 && variable > fixed) return 'High variable costs eroded margins this turn; tighten discretionary spending.'
      if (pl >= 0 && revenue > expenses) return 'Positive contribution margin covered fixed costs and produced profit‚Äîwell managed.'
      if (pl < 0) return 'A net loss increased liabilities pressure; consider boosting sponsorship assets or cutting costs.'
      return 'Stable performance with costs under control; maintain assets that drive recurring revenue.'
    }

    function applyDecisions(ops, mkt, ply){
      let log = []

      // ===== FIXED BUG: Apply merch payout from PREVIOUS turn FIRST =====
      const merchSales = S.merchPayoutNext
      S.merchPayoutNext = 0

      let variableCosts = 0

      // Operations
      if (ops === 'analyst'){
        variableCosts += 20000
        S.tsr += 5
        S.salaries += 5000
        S.analysts += 1
        log.push('Operations: Hired an Analyst (Variable ‚àí$20,000; Fixed +$5,000/turn; TSR +5).')
      } else if (ops === 'house'){
        variableCosts += 40000
        S.morale += 10
        S.fans += 500
        log.push('Operations: Upgraded Team House (Variable ‚àí$40,000; Morale +10; Fans +500).')
      } else if (ops === 'lean'){
        S.tsr -= 2
        log.push('Operations: Stayed Lean (no spend; TSR ‚àí2).')
      }

      // Marketing
      if (mkt === 'merch'){
        variableCosts += 25000
        S.fans += 1000
        S.merchPayoutNext = 10000
        log.push('Marketing: Launched Merch (Variable ‚àí$25,000; +1,000 Fans; +$10,000 merch revenue will arrive NEXT turn).')
      } else if (mkt === 'local'){
        variableCosts += 30000
        S.fans += 2000
        S.morale += 5
        log.push('Marketing: Hosted Local Tournament (Variable ‚àí$30,000; +2,000 Fans; Morale +5).')
      } else if (mkt === 'minimal'){
        log.push('Marketing: Minimal Social (no variable spend).')
      }

      // Player Focus
      if (ply === 'bootcamp'){
        S.tsr += 8
        S.morale -= 10
        log.push('Player Focus: Intense Bootcamp (TSR +8; Morale ‚àí10).')
      } else if (ply === 'retreat'){
        variableCosts += 10000
        S.morale += 10
        S.tsr -= 3
        log.push('Player Focus: Team Retreat (Variable ‚àí$10,000; Morale +10; TSR ‚àí3).')
      } else if (ply === 'balanced'){
        S.tsr += 2
        S.morale += 2
        log.push('Player Focus: Balanced Schedule (TSR +2; Morale +2).')
      }

      S.tsr = clamp(Math.round(S.tsr), 0, 100)
      S.morale = clamp(Math.round(S.morale), 0, 100)

      // Tournament
      const pWin = winProbability()
      const didWin = Math.random() < pWin
      const prizeTable = {1: 60000, 2: 35000, 3: 20000}
      let prizeMoney = didWin ? prizeTable[S.rank] : 0

      if (didWin){
        S.fans += 1500
        log.push(`Tournament outcome: WIN (p=${(pWin*100).toFixed(1)}%). Prize ${fmtMoney(prizeMoney)}, Fans +1,500.`)
      } else {
        variableCosts += 10000
        const fansBefore = S.fans
        S.fans = Math.max(0, Math.round(S.fans * 0.95))
        log.push(`Tournament outcome: LOSS (p=${(pWin*100).toFixed(1)}%). Sponsor penalty ‚àí$10,000; Fans ${fansBefore.toLocaleString()} ‚Üí ${S.fans.toLocaleString()} (‚àí5%).`)
      }

      // Financial calculation
      const sponsorships = Math.round((S.rank === 1 ? 30000 : S.rank === 2 ? 18000 : 9000) + Math.max(0, S.tsr - 50) * 120)
      const fixedExpenses = S.salaries
      const travel = 5000
      variableCosts += travel

      const totalRevenue = sponsorships + merchSales + prizeMoney
      const totalExpenses = fixedExpenses + variableCosts
      const profitLoss = totalRevenue - totalExpenses

      S.cash += profitLoss

      // Rank updates
      let promoted = false, demoted = false
      if (S.rank === 3 && S.tsr >= 70 && S.fans >= 7000){ S.rank = 2; promoted = true }
      else if (S.rank === 2 && S.tsr >= 80 && S.fans >= 12000){ S.rank = 1; promoted = true }
      else if (S.tsr <= 50 && S.morale <= 40 && S.fans < 5000 && S.rank < 3){ S.rank = 3; demoted = true }
      if (promoted) log.push(`Rank update: Promoted to ${rankName(S.rank)}!`)
      if (demoted) log.push(`Rank update: Demoted to ${rankName(S.rank)}.`)

      const fb = academicFeedback(profitLoss, {
        revenue: totalRevenue,
        expenses: totalExpenses,
        fixed: fixedExpenses,
        variable: variableCosts
      })

      log.push(
        `Revenue: Sponsorships ${fmtMoney(sponsorships)} + Prize ${fmtMoney(prizeMoney)} + Merch ${fmtMoney(merchSales)} = ${fmtMoney(totalRevenue)}`,
        `Expenses: Fixed ${fmtMoney(fixedExpenses)} + Variable ${fmtMoney(variableCosts)} = ${fmtMoney(totalExpenses)}`,
        `Turn Net: ${profitLoss >= 0 ? '+' : ''}${fmtMoney(profitLoss)}`,
        `Cash: ${fmtMoney(S.cash)} ‚Ä¢ TSR: ${S.tsr} ‚Ä¢ Morale: ${S.morale} ‚Ä¢ Fans: ${S.fans.toLocaleString()}`,
        `üí° ${fb}`
      )

      appendLog(log)

      // Failure checks
      if (S.cash < 0) S.negCashStreak = (S.negCashStreak||0) + 1; else S.negCashStreak = 0
      if (S.negCashStreak >= 2){
        gameOver('Financial Ruin', 'Cash reserves were below $0 for two consecutive turns.')
        return
      }
      if (S.morale <= 0){
        gameOver('Mutiny', 'Player morale fell to 0. The roster refuses to compete.')
        return
      }
    }

    function gameOver(reason, detail){
      const report = `\nGAME OVER ‚Äî ${reason}\n${detail}\nFinal Cash: ${fmtMoney(S.cash)}\nFans: ${S.fans.toLocaleString()}\nRank: ${rankName(S.rank)}\nTurns played: ${S.turn} / ${S.turnsTotal}`
      appendLog(report)
      el('btnConfirm').disabled = true
      $scenario.innerHTML = `<div class="notice badtext"><b>Game Over:</b> ${reason}. ${detail}</div>`
    }

    function endIfNeeded(){
      if (S.turn > S.turnsTotal){
        const endingCash = S.cash
        const endingRank = S.rank
        const endingFans = S.fans
        const profit = endingCash - STARTING.cash

        const rankSub = (endingRank === 1 ? 100 : endingRank === 2 ? 60 : 30)
        const profitSub = (function(){
          const min = -100000, max = 200000
          const pct = (profit - min) / (max - min)
          return clamp(Math.round(pct*100), 0, 100)
        })()
        const fanSub = clamp(Math.round((endingFans / 20000) * 100), 0, 100)

        const finalScore = Math.round(rankSub*0.40 + profitSub*0.40 + fanSub*0.20)

        function assessment(){
          const avoidedRuin = (S.negCashStreak||0) < 2 && !(endingCash < 0)
          const balanced = (S.tsr >= 60 && S.morale >= 60) || (profit > 0 && endingRank <= 2)
          const profitable = profit > 0
          const a = avoidedRuin ? 'You avoided financial ruin' : 'You flirted with financial ruin'
          const b = balanced ? 'balanced short‚Äëterm performance with long‚Äëterm capability building' : 'over‚Äëweighted either short‚Äëterm pushes or long‚Äëterm investments'
          const c = profitable ? 'your revenues exceeded expenses to produce profit' : 'expenses outpaced revenues, resulting in a loss'
          return `${a}, ${b}, and ${c}. Consider how fixed costs (salaries) and variable decisions (marketing, travel, retreats) influenced contribution margin and your path to break‚Äëeven.`
        }

        const stat = (key,val,note) => `<div class="stat"><b>${key}</b><div style="font-size:20px;margin:4px 0">${val}</div>${note?`<div class="muted" style="font-size:12px">${note}</div>`:''}</div>`

        const screen = `
          <div class="notice goodtext">
            <b>üéä GAME COMPLETE!</b> You have reached the end of Turn 8.
          </div>
          <h3>Final Scoring Screen</h3>
          <div class=\"stats\">
            ${stat('Student', (S.name && S.name.trim()) ? S.name.trim() : 'Manager X', '')}
            ${stat('Final Cash Reserves', fmtMoney(endingCash), '')}
            ${stat('Final Team Rank', rankName(endingRank), '')}
            ${stat('Final Fan Base', endingFans.toLocaleString() + ' followers', '')}
          </div>
          <div class=\"divider\"></div>
          <div class="section-title">Score Breakdown (out of 100)</div>
          <div class="stat">Rank Score (40%): ${rankSub} ‚Üí √ó0.40 = ${(rankSub*0.40).toFixed(1)}</div>
          <div class="stat">Profit Score (40%): ${profitSub} ‚Üí √ó0.40 = ${(profitSub*0.40).toFixed(1)}</div>
          <div class="stat">Fan Base Score (20%): ${fanSub} ‚Üí √ó0.20 = ${(fanSub*0.20).toFixed(1)}</div>
          <div class="stat"><b>Final Score</b>: ${finalScore} / 100</div>
          <div class=\"divider\"></div>
          <div class="section-title">Final Assessment</div>
          <p class="muted">${assessment()}</p>
          <div class=\"divider\"></div>
          <div class="end"><button id="btnPDF" class="btn good"><b>Save Final Report (PDF)</b></button></div>
        `

        $scenario.innerHTML = screen
        const pdfBtn = document.getElementById('btnPDF'); if(pdfBtn){ pdfBtn.addEventListener('click', ()=>window.print()) }
        appendLog([`\nFINAL VALUES: Cash ${fmtMoney(endingCash)} ¬∑ Rank ${rankName(endingRank)} ¬∑ Fans ${endingFans.toLocaleString()}`])
        el('btnConfirm').disabled = true
      }
    }

    // UI events
    el('btnConfirm').addEventListener('click', () => {
      if (S.turn > S.turnsTotal){ return }
      const ops = getChoice('ops')
      const mkt = getChoice('mkt')
      const ply = getChoice('ply')
      if (!ops || !mkt || !ply){
        alert('Please make exactly one selection in each category (Operations, Marketing, Player Focus).')
        return
      }
      if (!$name || !($name.value || '').trim()){
        if (!confirm('Proceed without entering a student name? It will show as "Manager X" on the final report.')) return
        S.name = ''
      } else {
        S.name = ($name.value || '').trim()
      }

      applyDecisions(ops, mkt, ply)
      clearChoices()

      S.turn += 1
      render()
      endIfNeeded()
      saveLocal('autosave', S)
    })

    el('btnReset').addEventListener('click', () => {
      if (!confirm('Reset game to Turn 1?')) return
      S = JSON.parse(JSON.stringify(STARTING))
      S.seenTutorial = true
      $log.textContent = ''
      render()
      el('btnConfirm').disabled = false
      saveLocal('autosave', S)
    })

    el('btnPrint').addEventListener('click', () => window.print())

    el('btnSave').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(S, null, 2)], {type:'application/json'})
      const a = document.createElement('a')
      a.href = URL.createObjectURL(blob)
      a.download = 'managerx-save.json'
      a.click()
      URL.revokeObjectURL(a.href)
    })

    el('btnLoad').addEventListener('click', () => {
      const inp = document.createElement('input')
      inp.type = 'file'
      inp.accept = '.json,application/json'
      inp.onchange = () => {
        const f = inp.files && inp.files[0]
        if (!f) return
        const reader = new FileReader()
        reader.onload = () => {
          try{
            const data = JSON.parse(reader.result)
            Object.assign(S, data)
            S.seenTutorial = true
            render()
            $log.textContent = ''
            appendLog('Save loaded. Continue your run!')
          }catch(err){ alert('Could not load save file.') }
        }
        reader.readAsText(f)
      }
      inp.click()
    })

    el('btnHelp').addEventListener('click', () => {
      $modal.style.display = 'flex'
    })

    el('btnStartGame').addEventListener('click', () => {
      $modal.style.display = 'none'
      S.seenTutorial = true
      saveLocal('autosave', S)
    })

    function saveLocal(key, obj){ try{ localStorage.setItem(key, JSON.stringify(obj)) }catch(_){} }
    function loadLocal(key){ try{ return JSON.parse(localStorage.getItem(key)||'null') }catch(_){ return null } }

    const auto = loadLocal('autosave')
    if (auto && auto.turn && auto.turn <= auto.turnsTotal+1){
      S = auto
      appendLog('Autosave loaded. Continue where you left off!')
      if (!S.seenTutorial){
        $modal.style.display = 'flex'
      }
    } else {
      appendLog('Welcome, Manager X! Click the Tutorial button if this is your first time playing.')
      $modal.style.display = 'flex'
    }

    render()
  })()
  </script>
</body>
</html>
</html>


